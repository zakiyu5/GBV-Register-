from flask import Flask, render_template, request, flash, redirect, url_for, send_file, session, jsonify
import sqlite3
from datetime import datetime, timedelta
import json
import pandas as pd
from io import BytesIO
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps
import hashlib
import os
from dateutil.relativedelta import relativedelta

app = Flask(__name__)
app.secret_key = os.getenv('FLASK_SECRET_KEY') or 'kayunga_gbv_hospital_2026_secure_key'

DB_NAME = 'gbv_kayunga_hospital.db'

def init_db():
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    # Patients table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS patients (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            patient_id TEXT UNIQUE NOT NULL,
            serial_no TEXT,
            arrival_datetime TEXT NOT NULL,
            national_id TEXT,
            client_name TEXT NOT NULL,
            address TEXT,
            contact_no TEXT,
            next_of_kin TEXT,
            next_of_kin_contact TEXT,
            ovc TEXT,
            age INTEGER NOT NULL,
            sex TEXT NOT NULL,
            marital_status TEXT,
            incident_datetime TEXT,
            medical_form_filled TEXT,
            p3_form TEXT,
            disability TEXT,
            perpetrator_relation TEXT,
            type_violence TEXT NOT NULL,
            type_case TEXT,
            facility_name TEXT DEFAULT 'Kayunga Regional Referral Hospital',
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Initial visit table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS initial_visits (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            patient_id TEXT,
            visit_date TEXT,
            hiv_test_initial TEXT,
            pregnancy_test TEXT,
            anal_swab TEXT,
            hvs TEXT,
            spermatozoa TEXT,
            urinalysis TEXT,
            hep_b_initial TEXT,
            syphilis_initial TEXT,
            ecp_given TEXT,
            pep_given TEXT,
            sti_treatment TEXT,
            trauma_counseling_initial TEXT,
            adherence_counseling_initial TEXT,
            tt_given_initial TEXT,
            hep_b_vaccine_initial TEXT,
            syphilis_treatment TEXT,
            referral_initial TEXT,
            referral_facility TEXT,
            notes TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (patient_id) REFERENCES patients (patient_id)
        )
    ''')
    
    # Follow-ups table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS follow_ups (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            patient_id TEXT,
            followup_type TEXT CHECK(followup_type IN ('2weeks', '1month', '3months', '6months')),
            followup_date TEXT,
            actual_return_date TEXT,
            next_appointment TEXT,
            referral TEXT,
            trauma_counseling TEXT,
            adherence_counseling TEXT,
            pep_refill TEXT,
            hiv_test TEXT,
            pregnancy_test TEXT,
            hb_level REAL,
            alt_level INTEGER,
            hep_b_vaccine TEXT,
            tt_given TEXT,
            syphilis_test TEXT,
            referral_update TEXT,
            pep_completion TEXT,
            notes TEXT,
            staff_name TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (patient_id) REFERENCES patients (patient_id),
            UNIQUE(patient_id, followup_type)
        )
    ''')
    
    # Client outcomes table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS client_outcomes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            patient_id TEXT UNIQUE,
            outcome TEXT,
            outcome_date TEXT,
            outcome_type TEXT CHECK(outcome_type IN ('completed', 'transferred', 'defaulted', 'died', 'other')),
            notes TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (patient_id) REFERENCES patients (patient_id)
        )
    ''')
    
    # Users table
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            full_name TEXT NOT NULL,
            password TEXT NOT NULL,
            role TEXT NOT NULL,
            department TEXT,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Create admin if not exists
    cursor.execute("SELECT * FROM users WHERE username = 'admin'")
    if not cursor.fetchone():
        hashed_pw = generate_password_hash('admin123')
        cursor.execute("INSERT INTO users (username, full_name, password, role) VALUES (?, ?, ?, ?)", 
                      ('admin', 'System Administrator', hashed_pw, 'admin'))
    
    # Create default nurse user
    cursor.execute("SELECT * FROM users WHERE username = 'nurse'")
    if not cursor.fetchone():
        hashed_pw = generate_password_hash('nurse123')
        cursor.execute("INSERT INTO users (username, full_name, password, role, department) VALUES (?, ?, ?, ?, ?)", 
                      ('nurse', 'GBV Department Nurse', hashed_pw, 'nurse', 'GBV Clinic'))
    
    conn.commit()
    conn.close()

init_db()

def get_db():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def to_float(val, default=0.0):
    if val in (None, '', 'ND', 'NA', 'nd', 'na', 'Not Done', 'Not Applicable'):
        return default
    try:
        return float(val)
    except:
        return default

def to_int(val, default=0):
    if val in (None, '', 'ND', 'NA', 'nd', 'na', 'Not Done', 'Not Applicable'):
        return default
    try:
        return int(val)
    except:
        return default

def format_date_for_input(date_str):
    if not date_str:
        return ''
    try:
        dt = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
        return dt.strftime('%Y-%m-%dT%H:%M')
    except:
        try:
            dt = datetime.strptime(date_str, '%Y-%m-%d')
            return dt.strftime('%Y-%m-%d')
        except:
            return date_str

# ============ CONTEXT PROCESSORS ============
@app.context_processor
def inject_now():
    return {'now': datetime.now()}

# ============ JINJA2 FILTERS ============
@app.template_filter('format_datetime')
def format_datetime(value, format='%Y-%m-%d %H:%M'):
    if not value:
        return ''
    try:
        dt = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')
        return dt.strftime(format)
    except:
        return value

@app.template_filter('format_date')
def format_date(value):
    if not value:
        return ''
    try:
        dt = datetime.strptime(value, '%Y-%m-%d')
        return dt.strftime('%d/%m/%Y')
    except:
        return value

@app.template_filter('format_datetime_for_input')
def format_datetime_for_input(value):
    if not value:
        return ''
    try:
        dt = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')
        return dt.strftime('%Y-%m-%dT%H:%M')
    except:
        try:
            dt = datetime.strptime(value, '%Y-%m-%d')
            return dt.strftime('%Y-%m-%d')
        except:
            return value

# ============ DECORATORS ============
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('Please log in to access this page.', 'warning')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_role' not in session or session['user_role'] != 'admin':
            flash('Admin access required.', 'danger')
            return redirect(url_for('dashboard'))
        return f(*args, **kwargs)
    return decorated_function

# ============ ROUTES ============
@app.route('/')
def index():
    return redirect(url_for('login'))

@app.route('/dashboard')
@login_required
def dashboard():
    conn = get_db()
    
    # Get counts
    cursor = conn.cursor()
    cursor.execute('SELECT COUNT(*) FROM patients')
    total_patients = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM patients WHERE sex = "F"')
    female_patients = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM patients WHERE age < 18')
    child_patients = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM patients WHERE DATE(created_at) = DATE("now")')
    today_patients = cursor.fetchone()[0]
    
    conn.close()
    
    return render_template('dashboard.html',
                         total_patients=total_patients,
                         female_patients=female_patients,
                         child_patients=child_patients,
                         today_patients=today_patients)

# ============ AUTH ROUTES ============
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        conn = get_db()
        user = conn.execute('SELECT * FROM users WHERE username = ?', (username,)).fetchone()
        conn.close()
        
        if user and check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['user_role'] = user['role']
            session['username'] = user['username']
            session['full_name'] = user['full_name']
            flash(f'Welcome back, {user["full_name"]}!', 'success')
            return redirect(url_for('dashboard'))
        flash('Invalid username or password.', 'danger')
    
    return render_template('login.html')

@app.route('/logout')
def logout():
    username = session.get('username', 'User')
    session.clear()
    flash(f'Goodbye, {username}! You have been logged out.', 'info')
    return redirect(url_for('login'))

@app.route('/change_password', methods=['GET', 'POST'])
@login_required
def change_password():
    if request.method == 'POST':
        current_password = request.form.get('current_password')
        new_password = request.form.get('new_password')
        confirm_password = request.form.get('confirm_password')
        
        if new_password != confirm_password:
            flash('New passwords do not match.', 'danger')
            return redirect(url_for('change_password'))
        
        if len(new_password) < 6:
            flash('Password must be at least 6 characters.', 'danger')
            return redirect(url_for('change_password'))
        
        conn = get_db()
        user = conn.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],)).fetchone()
        
        if not check_password_hash(user['password'], current_password):
            flash('Current password is incorrect.', 'danger')
            conn.close()
            return redirect(url_for('change_password'))
        
        hashed_pw = generate_password_hash(new_password)
        conn.execute('UPDATE users SET password = ? WHERE id = ?', (hashed_pw, session['user_id']))
        conn.commit()
        conn.close()
        
        flash('Password changed successfully!', 'success')
        return redirect(url_for('dashboard'))
    
    return render_template('change_password.html')

# ============ USER MANAGEMENT ============
@app.route('/admin/users', methods=['GET', 'POST'])
@login_required
@admin_required
def manage_users():
    conn = get_db()
    
    if request.method == 'POST':
        username = request.form.get('username')
        full_name = request.form.get('full_name')
        password = request.form.get('password')
        role = request.form.get('role', 'nurse')
        department = request.form.get('department', 'GBV Clinic')
        
        if not username or not full_name or not password:
            flash('Please fill all required fields.', 'danger')
            return redirect(url_for('manage_users'))
        
        try:
            hashed_pw = generate_password_hash(password)
            conn.execute('''
                INSERT INTO users (username, full_name, password, role, department)
                VALUES (?, ?, ?, ?, ?)
            ''', (username, full_name, hashed_pw, role, department))
            conn.commit()
            flash(f'User "{full_name}" created successfully!', 'success')
        except sqlite3.IntegrityError:
            flash(f'Username "{username}" already exists.', 'danger')
        finally:
            conn.close()
        return redirect(url_for('manage_users'))
    
    cursor = conn.cursor()
    cursor.execute('SELECT id, username, full_name, role, department, created_at FROM users ORDER BY role, username')
    users = cursor.fetchall()
    conn.close()
    
    return render_template('manage_users.html', users=users)

@app.route('/admin/users/delete/<int:user_id>', methods=['POST'])
@login_required
@admin_required
def delete_user(user_id):
    if user_id == session['user_id']:
        flash('Cannot delete your own account.', 'danger')
        return redirect(url_for('manage_users'))
    
    conn = get_db()
    conn.execute('DELETE FROM users WHERE id = ?', (user_id,))
    conn.commit()
    conn.close()
    flash('User deleted successfully.', 'success')
    return redirect(url_for('manage_users'))

# ============ PATIENT REGISTRATION ============
@app.route('/register_patient', methods=['GET', 'POST'])
@login_required
def register_patient():
    if request.method == 'POST':
        # Generate patient ID
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        patient_id = f"GBV-KAY-{timestamp}"
        
        conn = get_db()
        cursor = conn.cursor()
        
        try:
            # Insert patient
            cursor.execute('''
                INSERT INTO patients 
                (patient_id, serial_no, arrival_datetime, national_id, client_name, address, 
                 contact_no, next_of_kin, next_of_kin_contact, ovc, age, sex, marital_status, 
                 incident_datetime, medical_form_filled, p3_form, disability, perpetrator_relation, 
                 type_violence, type_case, facility_name)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                patient_id,
                request.form.get('serial_no'),
                request.form.get('arrival_datetime'),
                request.form.get('national_id'),
                request.form.get('client_name'),
                request.form.get('address'),
                request.form.get('contact_no'),
                request.form.get('next_of_kin'),
                request.form.get('next_of_kin_contact'),
                request.form.get('ovc'),
                to_int(request.form.get('age')),
                request.form.get('sex'),
                request.form.get('marital_status'),
                request.form.get('incident_datetime'),
                request.form.get('medical_form_filled'),
                request.form.get('p3_form'),
                request.form.get('disability'),
                request.form.get('perpetrator_relation'),
                request.form.get('type_violence'),
                request.form.get('type_case'),
                request.form.get('facility_name', 'Kayunga Regional Referral Hospital')
            ))
            
            # Check if initial visit data exists
            initial_fields = ['hiv_test_initial', 'pregnancy_test', 'pep_given', 'ecp_given']
            if any(request.form.get(field) for field in initial_fields):
                cursor.execute('''
                    INSERT INTO initial_visits 
                    (patient_id, visit_date, hiv_test_initial, pregnancy_test, anal_swab, hvs, 
                     spermatozoa, urinalysis, hep_b_initial, syphilis_initial, ecp_given, pep_given, 
                     sti_treatment, trauma_counseling_initial, adherence_counseling_initial, 
                     tt_given_initial, hep_b_vaccine_initial, syphilis_treatment, referral_initial,
                     referral_facility, notes)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    patient_id,
                    request.form.get('arrival_datetime'),
                    request.form.get('hiv_test_initial'),
                    request.form.get('pregnancy_test'),
                    request.form.get('anal_swab'),
                    request.form.get('hvs'),
                    request.form.get('spermatozoa'),
                    request.form.get('urinalysis'),
                    request.form.get('hep_b_initial'),
                    request.form.get('syphilis_initial'),
                    request.form.get('ecp_given'),
                    request.form.get('pep_given'),
                    request.form.get('sti_treatment'),
                    request.form.get('trauma_counseling_initial'),
                    request.form.get('adherence_counseling_initial'),
                    request.form.get('tt_given_initial'),
                    request.form.get('hep_b_vaccine_initial'),
                    request.form.get('syphilis_treatment'),
                    request.form.get('referral_initial'),
                    request.form.get('referral_facility'),
                    request.form.get('initial_notes')
                ))
            
            conn.commit()
            
            # Calculate next appointment date (2 weeks from arrival)
            try:
                arrival_date = datetime.strptime(request.form.get('arrival_datetime'), '%Y-%m-%dT%H:%M')
                next_appointment = (arrival_date + timedelta(days=14)).strftime('%Y-%m-%d')
            except:
                next_appointment = ''
            
            flash(f'''
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle"></i> Patient Registered Successfully!</h5>
                    <p><strong>Patient ID:</strong> {patient_id}</p>
                    <p><strong>Client:</strong> {request.form.get('client_name')}</p>
                    <p><strong>Recommended Next Appointment:</strong> {next_appointment if next_appointment else 'Please calculate manually'}</p>
                    <p class="mb-0">You can now search for this patient to add follow-ups.</p>
                </div>
            ''', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('register_patient'))
    
    # Calculate default dates
    today = datetime.now().strftime('%Y-%m-%d')
    arrival_datetime = datetime.now().strftime('%Y-%m-%dT%H:%M')
    
    return render_template('register_patient.html', 
                         today=today, 
                         arrival_datetime=arrival_datetime)

# ============ PATIENT LOOKUP ============
@app.route('/patient_lookup', methods=['GET', 'POST'])
@login_required
def patient_lookup():
    patient = None
    initial_visit = None
    follow_ups = []
    outcome = None
    
    if request.method == 'POST':
        search_term = request.form.get('search_term', '').strip()
        search_by = request.form.get('search_by', 'patient_id')
        
        if not search_term:
            flash('Please enter a search term', 'warning')
            return render_template('patient_lookup.html')
        
        conn = get_db()
        
        try:
            query_map = {
                'patient_id': 'patient_id = ?',
                'national_id': 'national_id = ?',
                'serial_no': 'serial_no = ?',
                'name': 'client_name LIKE ?',
                'contact': 'contact_no LIKE ?'
            }
            
            if search_by not in query_map:
                flash('Invalid search type', 'danger')
                return redirect(url_for('patient_lookup'))
            
            query = f'SELECT * FROM patients WHERE {query_map[search_by]}'
            params = [search_term] if search_by != 'name' and search_by != 'contact' else [f'%{search_term}%']
            
            patient = conn.execute(query, params).fetchone()
            
            if patient:
                initial_visit = conn.execute('SELECT * FROM initial_visits WHERE patient_id = ?', 
                                           (patient['patient_id'],)).fetchone()
                follow_ups = conn.execute('''
                    SELECT * FROM follow_ups 
                    WHERE patient_id = ? 
                    ORDER BY CASE followup_type
                        WHEN '2weeks' THEN 1
                        WHEN '1month' THEN 2
                        WHEN '3months' THEN 3
                        WHEN '6months' THEN 4
                        ELSE 5
                    END
                ''', (patient['patient_id'],)).fetchall()
                outcome = conn.execute('SELECT * FROM client_outcomes WHERE patient_id = ?', 
                                     (patient['patient_id'],)).fetchone()
            else:
                flash(f'No patient found with {search_by}: {search_term}', 'warning')
                
        except Exception as e:
            flash(f'Search error: {str(e)}', 'danger')
        finally:
            conn.close()
    
    return render_template('patient_lookup.html',
                         patient=patient,
                         initial_visit=initial_visit,
                         follow_ups=follow_ups,
                         outcome=outcome)

# ============ FOLLOW-UP MANAGEMENT ============
@app.route('/add_followup/<patient_id>', methods=['GET', 'POST'])
@login_required
def add_followup(patient_id):
    conn = get_db()
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', (patient_id,)).fetchone()
    
    if not patient:
        flash('Patient not found', 'danger')
        conn.close()
        return redirect(url_for('patient_lookup'))
    
    # Get existing follow-ups
    existing_followups = conn.execute('SELECT followup_type FROM follow_ups WHERE patient_id = ?', 
                                    (patient_id,)).fetchall()
    existing_types = [fu['followup_type'] for fu in existing_followups]
    
    # Calculate next follow-up type
    all_types = ['2weeks', '1month', '3months', '6months']
    available_types = [t for t in all_types if t not in existing_types]
    
    # Get last follow-up date to suggest next date
    last_followup = conn.execute('''
        SELECT MAX(followup_date) as last_date FROM follow_ups 
        WHERE patient_id = ?
    ''', (patient_id,)).fetchone()
    
    # Calculate suggested date
    suggested_date = datetime.now().strftime('%Y-%m-%d')
    if available_types:
        next_type = available_types[0]
        try:
            arrival_date = datetime.strptime(patient['arrival_datetime'], '%Y-%m-%d %H:%M:%S')
            if next_type == '2weeks':
                suggested_date = (arrival_date + timedelta(days=14)).strftime('%Y-%m-%d')
            elif next_type == '1month':
                suggested_date = (arrival_date + relativedelta(months=1)).strftime('%Y-%m-%d')
            elif next_type == '3months':
                suggested_date = (arrival_date + relativedelta(months=3)).strftime('%Y-%m-%d')
            elif next_type == '6months':
                suggested_date = (arrival_date + relativedelta(months=6)).strftime('%Y-%m-%d')
        except:
            pass
    
    if request.method == 'POST':
        followup_type = request.form.get('followup_type')
        
        if not followup_type:
            flash('Please select follow-up type', 'warning')
            conn.close()
            return render_template('add_followup.html',
                                 patient=patient,
                                 available_types=available_types,
                                 existing_types=existing_types,
                                 suggested_date=suggested_date)
        
        if followup_type in existing_types:
            flash(f'{followup_type} follow-up already exists', 'warning')
            conn.close()
            return redirect(url_for('patient_lookup', search_term=patient_id, search_by='patient_id'))
        
        try:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO follow_ups 
                (patient_id, followup_type, followup_date, actual_return_date, next_appointment,
                 referral, trauma_counseling, adherence_counseling, pep_refill, hiv_test,
                 pregnancy_test, hb_level, alt_level, hep_b_vaccine, tt_given, syphilis_test,
                 referral_update, pep_completion, notes, staff_name)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                patient_id,
                followup_type,
                request.form.get('followup_date'),
                request.form.get('actual_return_date'),
                request.form.get('next_appointment'),
                request.form.get('referral'),
                request.form.get('trauma_counseling'),
                request.form.get('adherence_counseling'),
                request.form.get('pep_refill'),
                request.form.get('hiv_test'),
                request.form.get('pregnancy_test'),
                to_float(request.form.get('hb_level')),
                to_int(request.form.get('alt_level')),
                request.form.get('hep_b_vaccine'),
                request.form.get('tt_given'),
                request.form.get('syphilis_test'),
                request.form.get('referral_update'),
                request.form.get('pep_completion'),
                request.form.get('notes'),
                session.get('full_name', 'Unknown Staff')
            ))
            
            conn.commit()
            
            # Get follow-up name for display
            followup_names = {
                '2weeks': '2 Weeks',
                '1month': '1 Month', 
                '3months': '3 Months',
                '6months': '6 Months'
            }
            
            flash(f'''
                <div class="alert alert-success">
                    <i class="fas fa-calendar-check"></i> {followup_names.get(followup_type, followup_type)} 
                    Follow-up added successfully for {patient["client_name"]}!
                </div>
            ''', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('patient_lookup', search_term=patient_id, search_by='patient_id'))
    
    conn.close()
    
    return render_template('add_followup.html',
                         patient=patient,
                         available_types=available_types,
                         existing_types=existing_types,
                         suggested_date=suggested_date,
                         today=datetime.now().strftime('%Y-%m-%d'))

@app.route('/edit_followup/<int:followup_id>', methods=['GET', 'POST'])
@login_required
def edit_followup(followup_id):
    conn = get_db()
    followup = conn.execute('SELECT * FROM follow_ups WHERE id = ?', (followup_id,)).fetchone()
    
    if not followup:
        flash('Follow-up not found', 'danger')
        conn.close()
        return redirect(url_for('patient_lookup'))
    
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', 
                         (followup['patient_id'],)).fetchone()
    
    if request.method == 'POST':
        try:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE follow_ups SET
                    followup_date = ?,
                    actual_return_date = ?,
                    next_appointment = ?,
                    referral = ?,
                    trauma_counseling = ?,
                    adherence_counseling = ?,
                    pep_refill = ?,
                    hiv_test = ?,
                    pregnancy_test = ?,
                    hb_level = ?,
                    alt_level = ?,
                    hep_b_vaccine = ?,
                    tt_given = ?,
                    syphilis_test = ?,
                    referral_update = ?,
                    pep_completion = ?,
                    notes = ?,
                    staff_name = ?
                WHERE id = ?
            ''', (
                request.form.get('followup_date'),
                request.form.get('actual_return_date'),
                request.form.get('next_appointment'),
                request.form.get('referral'),
                request.form.get('trauma_counseling'),
                request.form.get('adherence_counseling'),
                request.form.get('pep_refill'),
                request.form.get('hiv_test'),
                request.form.get('pregnancy_test'),
                to_float(request.form.get('hb_level')),
                to_int(request.form.get('alt_level')),
                request.form.get('hep_b_vaccine'),
                request.form.get('tt_given'),
                request.form.get('syphilis_test'),
                request.form.get('referral_update'),
                request.form.get('pep_completion'),
                request.form.get('notes'),
                session.get('full_name', 'Unknown Staff'),
                followup_id
            ))
            
            conn.commit()
            flash('<div class="alert alert-success"><i class="fas fa-check-circle"></i> Follow-up updated successfully!</div>', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('patient_lookup', search_term=patient['patient_id'], search_by='patient_id'))
    
    conn.close()
    
    return render_template('edit_followup.html', followup=followup, patient=patient)

# ============ INITIAL VISIT MANAGEMENT ============
@app.route('/edit_initial_visit/<patient_id>', methods=['GET', 'POST'])
@login_required
def edit_initial_visit(patient_id):
    conn = get_db()
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', (patient_id,)).fetchone()
    
    if not patient:
        flash('Patient not found', 'danger')
        conn.close()
        return redirect(url_for('patient_lookup'))
    
    initial_visit = conn.execute('SELECT * FROM initial_visits WHERE patient_id = ?', 
                               (patient_id,)).fetchone()
    
    if request.method == 'POST':
        try:
            cursor = conn.cursor()
            
            if initial_visit:
                cursor.execute('''
                    UPDATE initial_visits SET
                        visit_date = ?,
                        hiv_test_initial = ?,
                        pregnancy_test = ?,
                        anal_swab = ?,
                        hvs = ?,
                        spermatozoa = ?,
                        urinalysis = ?,
                        hep_b_initial = ?,
                        syphilis_initial = ?,
                        ecp_given = ?,
                        pep_given = ?,
                        sti_treatment = ?,
                        trauma_counseling_initial = ?,
                        adherence_counseling_initial = ?,
                        tt_given_initial = ?,
                        hep_b_vaccine_initial = ?,
                        syphilis_treatment = ?,
                        referral_initial = ?,
                        referral_facility = ?,
                        notes = ?
                    WHERE patient_id = ?
                ''', (
                    request.form.get('visit_date'),
                    request.form.get('hiv_test_initial'),
                    request.form.get('pregnancy_test'),
                    request.form.get('anal_swab'),
                    request.form.get('hvs'),
                    request.form.get('spermatozoa'),
                    request.form.get('urinalysis'),
                    request.form.get('hep_b_initial'),
                    request.form.get('syphilis_initial'),
                    request.form.get('ecp_given'),
                    request.form.get('pep_given'),
                    request.form.get('sti_treatment'),
                    request.form.get('trauma_counseling_initial'),
                    request.form.get('adherence_counseling_initial'),
                    request.form.get('tt_given_initial'),
                    request.form.get('hep_b_vaccine_initial'),
                    request.form.get('syphilis_treatment'),
                    request.form.get('referral_initial'),
                    request.form.get('referral_facility'),
                    request.form.get('notes'),
                    patient_id
                ))
            else:
                cursor.execute('''
                    INSERT INTO initial_visits 
                    (patient_id, visit_date, hiv_test_initial, pregnancy_test, anal_swab, hvs, 
                     spermatozoa, urinalysis, hep_b_initial, syphilis_initial, ecp_given, pep_given, 
                     sti_treatment, trauma_counseling_initial, adherence_counseling_initial, 
                     tt_given_initial, hep_b_vaccine_initial, syphilis_treatment, referral_initial,
                     referral_facility, notes)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    patient_id,
                    request.form.get('visit_date'),
                    request.form.get('hiv_test_initial'),
                    request.form.get('pregnancy_test'),
                    request.form.get('anal_swab'),
                    request.form.get('hvs'),
                    request.form.get('spermatozoa'),
                    request.form.get('urinalysis'),
                    request.form.get('hep_b_initial'),
                    request.form.get('syphilis_initial'),
                    request.form.get('ecp_given'),
                    request.form.get('pep_given'),
                    request.form.get('sti_treatment'),
                    request.form.get('trauma_counseling_initial'),
                    request.form.get('adherence_counseling_initial'),
                    request.form.get('tt_given_initial'),
                    request.form.get('hep_b_vaccine_initial'),
                    request.form.get('syphilis_treatment'),
                    request.form.get('referral_initial'),
                    request.form.get('referral_facility'),
                    request.form.get('notes')
                ))
            
            conn.commit()
            flash('<div class="alert alert-success"><i class="fas fa-check-circle"></i> Initial visit updated successfully!</div>', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('patient_lookup', search_term=patient_id, search_by='patient_id'))
    
    conn.close()
    
    return render_template('edit_initial_visit.html', 
                         patient=patient, 
                         initial_visit=initial_visit,
                         today=datetime.now().strftime('%Y-%m-%d'))

# ============ PATIENT EDIT ============
@app.route('/edit_patient/<patient_id>', methods=['GET', 'POST'])
@login_required
def edit_patient(patient_id):
    conn = get_db()
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', (patient_id,)).fetchone()
    
    if not patient:
        flash('Patient not found', 'danger')
        conn.close()
        return redirect(url_for('patient_lookup'))
    
    if request.method == 'POST':
        try:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE patients SET
                    serial_no = ?,
                    arrival_datetime = ?,
                    national_id = ?,
                    client_name = ?,
                    address = ?,
                    contact_no = ?,
                    next_of_kin = ?,
                    next_of_kin_contact = ?,
                    ovc = ?,
                    age = ?,
                    sex = ?,
                    marital_status = ?,
                    incident_datetime = ?,
                    medical_form_filled = ?,
                    p3_form = ?,
                    disability = ?,
                    perpetrator_relation = ?,
                    type_violence = ?,
                    type_case = ?,
                    facility_name = ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE patient_id = ?
            ''', (
                request.form.get('serial_no'),
                request.form.get('arrival_datetime'),
                request.form.get('national_id'),
                request.form.get('client_name'),
                request.form.get('address'),
                request.form.get('contact_no'),
                request.form.get('next_of_kin'),
                request.form.get('next_of_kin_contact'),
                request.form.get('ovc'),
                to_int(request.form.get('age')),
                request.form.get('sex'),
                request.form.get('marital_status'),
                request.form.get('incident_datetime'),
                request.form.get('medical_form_filled'),
                request.form.get('p3_form'),
                request.form.get('disability'),
                request.form.get('perpetrator_relation'),
                request.form.get('type_violence'),
                request.form.get('type_case'),
                request.form.get('facility_name', 'Kayunga Regional Referral Hospital'),
                patient_id
            ))
            
            conn.commit()
            flash('<div class="alert alert-success"><i class="fas fa-check-circle"></i> Patient information updated successfully!</div>', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('patient_lookup', search_term=patient_id, search_by='patient_id'))
    
    conn.close()
    
    return render_template('edit_patient.html', patient=patient)

# ============ OUTCOME MANAGEMENT ============
@app.route('/add_outcome/<patient_id>', methods=['GET', 'POST'])
@login_required
def add_outcome(patient_id):
    conn = get_db()
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', (patient_id,)).fetchone()
    
    if not patient:
        flash('Patient not found', 'danger')
        conn.close()
        return redirect(url_for('patient_lookup'))
    
    existing_outcome = conn.execute('SELECT * FROM client_outcomes WHERE patient_id = ?', 
                                  (patient_id,)).fetchone()
    
    if request.method == 'POST':
        try:
            cursor = conn.cursor()
            
            if existing_outcome:
                cursor.execute('''
                    UPDATE client_outcomes 
                    SET outcome = ?, outcome_date = ?, outcome_type = ?, notes = ?
                    WHERE patient_id = ?
                ''', (
                    request.form.get('outcome'),
                    request.form.get('outcome_date'),
                    request.form.get('outcome_type'),
                    request.form.get('notes'),
                    patient_id
                ))
            else:
                cursor.execute('''
                    INSERT INTO client_outcomes (patient_id, outcome, outcome_date, outcome_type, notes)
                    VALUES (?, ?, ?, ?, ?)
                ''', (
                    patient_id,
                    request.form.get('outcome'),
                    request.form.get('outcome_date'),
                    request.form.get('outcome_type'),
                    request.form.get('notes')
                ))
            
            conn.commit()
            flash('<div class="alert alert-success"><i class="fas fa-check-circle"></i> Outcome recorded successfully!</div>', 'success')
            
        except sqlite3.Error as e:
            conn.rollback()
            flash(f'<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: {str(e)}</div>', 'danger')
        finally:
            conn.close()
        
        return redirect(url_for('patient_lookup', search_term=patient_id, search_by='patient_id'))
    
    conn.close()
    
    return render_template('add_outcome.html', 
                         patient=patient, 
                         existing_outcome=existing_outcome,
                         today=datetime.now().strftime('%Y-%m-%d'))

# ============ RECORDS & REPORTS ============
@app.route('/all_records')
@login_required
def all_records():
    search = request.args.get('search', '').strip()
    sex = request.args.get('sex', '')
    violence = request.args.get('violence', '')
    age_group = request.args.get('age_group', '')
    start_date = request.args.get('start_date', '')
    end_date = request.args.get('end_date', '')
    show_completed = request.args.get('show_completed', 'false') == 'true'
    
    conn = get_db()
    cursor = conn.cursor()
    
    # Build query
    query = '''
        SELECT p.*, 
               iv.hiv_test_initial, iv.pep_given,
               (SELECT COUNT(*) FROM follow_ups f WHERE f.patient_id = p.patient_id) as followup_count,
               co.outcome, co.outcome_date,
               CASE 
                   WHEN co.outcome IS NOT NULL THEN 'Completed'
                   WHEN (SELECT COUNT(*) FROM follow_ups f WHERE f.patient_id = p.patient_id) >= 4 THEN 'All Follow-ups Done'
                   ELSE 'In Progress'
               END as status
        FROM patients p
        LEFT JOIN initial_visits iv ON p.patient_id = iv.patient_id
        LEFT JOIN client_outcomes co ON p.patient_id = co.patient_id
        WHERE 1=1
    '''
    
    params = []
    
    if search:
        query += ' AND (p.client_name LIKE ? OR p.patient_id LIKE ? OR p.serial_no LIKE ? OR p.national_id LIKE ?)'
        like_term = f'%{search}%'
        params.extend([like_term, like_term, like_term, like_term])
    
    if sex:
        query += ' AND p.sex = ?'
        params.append(sex)
    
    if violence:
        query += ' AND p.type_violence = ?'
        params.append(violence)
    
    if age_group == 'child':
        query += ' AND p.age < 18'
    elif age_group == 'adult':
        query += ' AND p.age >= 18'
    
    if start_date:
        query += ' AND DATE(p.created_at) >= ?'
        params.append(start_date)
    
    if end_date:
        query += ' AND DATE(p.created_at) <= ?'
        params.append(end_date)
    
    if not show_completed:
        query += ' AND co.outcome IS NULL'
    
    query += ' ORDER BY p.created_at DESC'
    
    cursor.execute(query, params)
    records = cursor.fetchall()
    
    cursor.execute('SELECT COUNT(*) FROM patients')
    total_count = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM patients WHERE sex = "F"')
    female_count = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM patients WHERE age < 18')
    child_count = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM initial_visits WHERE pep_given = "Y"')
    pep_count = cursor.fetchone()[0]
    
    conn.close()
    
    return render_template('all_records.html',
                         records=records,
                         total_count=total_count,
                         female_count=female_count,
                         child_count=child_count,
                         pep_count=pep_count,
                         search=search,
                         sex=sex,
                         violence=violence,
                         age_group=age_group,
                         start_date=start_date,
                         end_date=end_date,
                         show_completed=show_completed)

@app.route('/reports')
@login_required
def reports():
    period = request.args.get('period', 'all')
    search = request.args.get('search', '').strip()
    sex = request.args.get('sex', '')
    violence = request.args.get('violence', '')
    age_group = request.args.get('age_group', '')
    custom_start = request.args.get('start_date', '')
    custom_end = request.args.get('end_date', '')
    
    end_date = datetime.now()
    start_date = None
    period_name = 'All Time'
    
    if period != 'all':
        if period == 'daily':
            start_date = end_date - timedelta(days=1)
            period_name = 'Daily'
        elif period == 'weekly':
            start_date = end_date - timedelta(weeks=1)
            period_name = 'Weekly'
        elif period == 'monthly':
            start_date = end_date.replace(day=1)
            period_name = 'Monthly'
        elif period == 'quarterly':
            quarter_start_month = ((end_date.month - 1) // 3 * 3) + 1
            start_date = end_date.replace(month=quarter_start_month, day=1)
            period_name = 'Quarterly'
        elif period == 'yearly':
            start_date = end_date.replace(month=1, day=1)
            period_name = 'Yearly'
    
    conn = get_db()
    cursor = conn.cursor()
    
    # Build query
    query = '''
        SELECT p.*, iv.pep_given, iv.hiv_test_initial,
               (SELECT COUNT(*) FROM follow_ups f WHERE f.patient_id = p.patient_id) as followup_count,
               co.outcome
        FROM patients p
        LEFT JOIN initial_visits iv ON p.patient_id = iv.patient_id
        LEFT JOIN client_outcomes co ON p.patient_id = co.patient_id
        WHERE 1=1
    '''
    count_query = 'SELECT COUNT(*) FROM patients WHERE 1=1'
    params = []
    
    if period != 'all' and start_date:
        query += ' AND p.created_at BETWEEN ? AND ?'
        count_query += ' AND created_at BETWEEN ? AND ?'
        params.extend([start_date, end_date])
    elif custom_start or custom_end:
        if custom_start:
            query += ' AND p.created_at >= ?'
            count_query += ' AND created_at >= ?'
            params.append(f'{custom_start} 00:00:00')
        if custom_end:
            query += ' AND p.created_at <= ?'
            count_query += ' AND created_at <= ?'
            params.append(f'{custom_end} 23:59:59')
    
    if search:
        like = f'%{search}%'
        query += ' AND (p.serial_no LIKE ? OR p.national_id LIKE ? OR p.client_name LIKE ?)'
        count_query += ' AND (serial_no LIKE ? OR national_id LIKE ? OR client_name LIKE ?)'
        params.extend([like, like, like])
    
    if sex:
        query += ' AND p.sex = ?'
        count_query += ' AND sex = ?'
        params.append(sex)
    
    if violence:
        query += ' AND p.type_violence = ?'
        count_query += ' AND type_violence = ?'
        params.append(violence)
    
    if age_group == 'child':
        query += ' AND p.age < 18'
        count_query += ' AND age < 18'
    elif age_group == 'adult':
        query += ' AND p.age >= 18'
        count_query += ' AND age >= 18'
    
    query += ' ORDER BY p.created_at DESC'
    
    cursor.execute(query, params)
    records = cursor.fetchall()
    
    cursor.execute(count_query, params)
    total_cases = cursor.fetchone()[0] or 0
    
    # Female count
    female_query = count_query + ' AND sex = "F"'
    cursor.execute(female_query, params)
    female_cases = cursor.fetchone()[0] or 0
    
    # Child count
    child_query = count_query + ' AND age < 18'
    cursor.execute(child_query, params)
    child_cases = cursor.fetchone()[0] or 0
    
    # PEP count
    pep_query = '''
        SELECT COUNT(DISTINCT p.id) 
        FROM patients p 
        LEFT JOIN initial_visits iv ON p.patient_id = iv.patient_id
        WHERE 1=1
    '''
    pep_params = []
    
    if period != 'all' and start_date:
        pep_query += ' AND p.created_at BETWEEN ? AND ?'
        pep_params.extend([start_date, end_date])
    
    pep_query += ' AND iv.pep_given = "Y"'
    cursor.execute(pep_query, pep_params)
    pep_cases = cursor.fetchone()[0] or 0
    
    conn.close()
    
    return render_template('reports.html',
                           records=records,
                           total_cases=total_cases,
                           female_cases=female_cases,
                           female_pct=round(female_cases/total_cases*100, 1) if total_cases else 0,
                           child_cases=child_cases,
                           child_pct=round(child_cases/total_cases*100, 1) if total_cases else 0,
                           pep_cases=pep_cases,
                           pep_pct=round(pep_cases/total_cases*100, 1) if total_cases else 0,
                           period=period_name,
                           start_date=start_date.strftime('%Y-%m-%d') if start_date else '',
                           end_date=end_date.strftime('%Y-%m-%d') if end_date else '',
                           current_period=period,
                           search=search,
                           sex=sex,
                           violence=violence,
                           age_group=age_group,
                           custom_start=custom_start,
                           custom_end=custom_end)

# ============ EXPORT FUNCTIONALITY ============
@app.route('/export_csv')
@login_required
def export_csv():
    period = request.args.get('period', 'all')
    search = request.args.get('search', '').strip()
    sex = request.args.get('sex', '')
    violence = request.args.get('violence', '')
    age_group = request.args.get('age_group', '')
    start_date = request.args.get('start_date', '')
    end_date = request.args.get('end_date', '')
    
    end_dt = datetime.now()
    start_dt = None
    
    if period != 'all':
        if period == 'daily':
            start_dt = end_dt - timedelta(days=1)
        elif period == 'weekly':
            start_dt = end_dt - timedelta(weeks=1)
        elif period == 'monthly':
            start_dt = end_dt.replace(day=1)
        elif period == 'quarterly':
            q_month = ((end_dt.month - 1) // 3 * 3) + 1
            start_dt = end_dt.replace(month=q_month, day=1)
        elif period == 'yearly':
            start_dt = end_dt.replace(month=1, day=1)
    
    conn = get_db()
    
    query = '''
        SELECT p.*, 
               iv.hiv_test_initial, iv.pregnancy_test, iv.pep_given, iv.ecp_given,
               (SELECT COUNT(*) FROM follow_ups f WHERE f.patient_id = p.patient_id) as followup_count,
               co.outcome, co.outcome_date
        FROM patients p
        LEFT JOIN initial_visits iv ON p.patient_id = iv.patient_id
        LEFT JOIN client_outcomes co ON p.patient_id = co.patient_id
        WHERE 1=1
    '''
    params = []
    
    if period != 'all' and start_dt:
        query += ' AND p.created_at BETWEEN ? AND ?'
        params.extend([start_dt, end_dt])
    elif start_date or end_date:
        if start_date:
            query += ' AND p.created_at >= ?'
            params.append(f'{start_date} 00:00:00')
        if end_date:
            query += ' AND p.created_at <= ?'
            params.append(f'{end_date} 23:59:59')
    
    if search:
        like = f'%{search}%'
        query += ' AND (p.serial_no LIKE ? OR p.national_id LIKE ? OR p.client_name LIKE ?)'
        params.extend([like, like, like])
    
    if sex:
        query += ' AND p.sex = ?'
        params.append(sex)
    
    if violence:
        query += ' AND p.type_violence = ?'
        params.append(violence)
    
    if age_group == 'child':
        query += ' AND p.age < 18'
    elif age_group == 'adult':
        query += ' AND p.age >= 18'
    
    query += ' ORDER BY p.created_at DESC'
    
    df = pd.read_sql_query(query, conn, params=params)
    conn.close()
    
    # Rename columns
    column_map = {
        'patient_id': 'Patient ID',
        'serial_no': 'Serial No',
        'arrival_datetime': 'Arrival Date',
        'national_id': 'National ID',
        'client_name': 'Client Name',
        'age': 'Age',
        'sex': 'Sex',
        'type_violence': 'Violence Type',
        'pep_given': 'PEP Given',
        'hiv_test_initial': 'Initial HIV Test',
        'followup_count': 'Follow-up Count',
        'outcome': 'Outcome',
        'created_at': 'Registration Date'
    }
    df.rename(columns=column_map, inplace=True)
    
    # Select only important columns
    important_cols = ['Patient ID', 'Serial No', 'Client Name', 'Age', 'Sex', 'Violence Type', 
                     'Arrival Date', 'PEP Given', 'Initial HIV Test', 'Follow-up Count', 
                     'Outcome', 'Registration Date']
    df = df[[col for col in important_cols if col in df.columns]]
    
    output = BytesIO()
    df.to_csv(output, index=False, encoding='utf-8-sig')
    output.seek(0)
    
    filename = f"gbv_kayunga_report_{datetime.now().strftime('%Y%m%d_%H%M')}.csv"
    
    return send_file(
        output,
        mimetype='text/csv',
        as_attachment=True,
        download_name=filename
    )

@app.route('/export_patient/<patient_id>')
@login_required
def export_patient(patient_id):
    conn = get_db()
    
    # Get patient data
    patient = conn.execute('SELECT * FROM patients WHERE patient_id = ?', (patient_id,)).fetchone()
    if not patient:
        flash('Patient not found', 'danger')
        return redirect(url_for('patient_lookup'))
    
    initial_visit = conn.execute('SELECT * FROM initial_visits WHERE patient_id = ?', 
                               (patient_id,)).fetchone()
    follow_ups = conn.execute('SELECT * FROM follow_ups WHERE patient_id = ? ORDER BY followup_date', 
                            (patient_id,)).fetchall()
    outcome = conn.execute('SELECT * FROM client_outcomes WHERE patient_id = ?', 
                         (patient_id,)).fetchone()
    
    # Create HTML report
    html_content = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>GBV Patient Report - {patient['client_name']}</title>
        <style>
            body {{ font-family: Arial, sans-serif; margin: 40px; }}
            .header {{ text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }}
            .section {{ margin-bottom: 25px; page-break-inside: avoid; }}
            .section-title {{ background-color: #f5f5f5; padding: 8px 15px; font-weight: bold; border-left: 4px solid #007bff; margin-bottom: 15px; }}
            table {{ width: 100%; border-collapse: collapse; margin-bottom: 15px; }}
            th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
            th {{ background-color: #f8f9fa; }}
            .footer {{ margin-top: 40px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>Kayunga Regional Referral Hospital</h1>
            <h2>Gender-Based Violence Patient Report</h2>
            <p>Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>
        
        <div class="section">
            <div class="section-title">Patient Information</div>
            <table>
                <tr><th>Patient ID:</th><td>{patient['patient_id']}</td></tr>
                <tr><th>Name:</th><td>{patient['client_name']}</td></tr>
                <tr><th>Age/Sex:</th><td>{patient['age']} / {patient['sex']}</td></tr>
                <tr><th>Arrival Date:</th><td>{patient['arrival_datetime']}</td></tr>
                <tr><th>Contact:</th><td>{patient['contact_no'] or 'N/A'}</td></tr>
                <tr><th>Violence Type:</th><td>{patient['type_violence'] or 'N/A'}</td></tr>
            </table>
        </div>
    '''
    
    if initial_visit:
        html_content += f'''
        <div class="section">
            <div class="section-title">Initial Visit</div>
            <table>
                <tr><th>HIV Test:</th><td>{initial_visit['hiv_test_initial'] or 'N/A'}</td></tr>
                <tr><th>PEP Given:</th><td>{initial_visit['pep_given'] or 'N/A'}</td></tr>
                <tr><th>Trauma Counseling:</th><td>{initial_visit['trauma_counseling_initial'] or 'N/A'}</td></tr>
            </table>
        </div>
        '''
    
    if follow_ups:
        html_content += '''
        <div class="section">
            <div class="section-title">Follow-ups</div>
            <table>
                <tr>
                    <th>Type</th><th>Date</th><th>HIV Test</th><th>PEP Refill</th><th>Counseling</th>
                </tr>
        '''
        for fu in follow_ups:
            html_content += f'''
                <tr>
                    <td>{fu['followup_type'].replace('2weeks', '2 Weeks').replace('1month', '1 Month').replace('3months', '3 Months').replace('6months', '6 Months')}</td>
                    <td>{fu['followup_date'] or 'N/A'}</td>
                    <td>{fu['hiv_test'] or 'N/A'}</td>
                    <td>{fu['pep_refill'] or 'N/A'}</td>
                    <td>{fu['trauma_counseling'] or 'N/A'}</td>
                </tr>
            '''
        html_content += '</table></div>'
    
    if outcome:
        html_content += f'''
        <div class="section">
            <div class="section-title">Client Outcome</div>
            <table>
                <tr><th>Outcome:</th><td>{outcome['outcome']}</td></tr>
                <tr><th>Date:</th><td>{outcome['outcome_date']}</td></tr>
                <tr><th>Notes:</th><td>{outcome['notes'] or 'N/A'}</td></tr>
            </table>
        </div>
        '''
    
    html_content += f'''
        <div class="footer">
            <p>Confidential Medical Record - For authorized personnel only</p>
            <p>Kayunga Regional Referral Hospital - GBV Department</p>
        </div>
    </body>
    </html>
    '''
    
    output = BytesIO()
    output.write(html_content.encode('utf-8'))
    output.seek(0)
    
    filename = f"gbv_patient_{patient['patient_id']}_{datetime.now().strftime('%Y%m%d')}.html"
    
    return send_file(
        output,
        mimetype='text/html',
        as_attachment=True,
        download_name=filename
    )

# ============ DASHBOARD DATA API ============
@app.route('/api/dashboard_stats')
@login_required
def dashboard_stats():
    period = request.args.get('period', 'month')
    
    conn = get_db()
    cursor = conn.cursor()
    
    # Calculate date range
    end_date = datetime.now()
    if period == 'week':
        start_date = end_date - timedelta(days=7)
    elif period == 'month':
        start_date = end_date - timedelta(days=30)
    elif period == 'quarter':
        start_date = end_date - timedelta(days=90)
    else:  # year
        start_date = end_date - timedelta(days=365)
    
    # Total cases
    cursor.execute('SELECT COUNT(*) FROM patients WHERE created_at BETWEEN ? AND ?', 
                  (start_date, end_date))
    total_cases = cursor.fetchone()[0]
    
    # New cases this week
    week_start = end_date - timedelta(days=7)
    cursor.execute('SELECT COUNT(*) FROM patients WHERE created_at BETWEEN ? AND ?', 
                  (week_start, end_date))
    new_cases = cursor.fetchone()[0]
    
    # Female cases
    cursor.execute('SELECT COUNT(*) FROM patients WHERE sex = "F" AND created_at BETWEEN ? AND ?', 
                  (start_date, end_date))
    female_cases = cursor.fetchone()[0]
    
    # Child cases
    cursor.execute('SELECT COUNT(*) FROM patients WHERE age < 18 AND created_at BETWEEN ? AND ?', 
                  (start_date, end_date))
    child_cases = cursor.fetchone()[0]
    
    # PEP cases
    cursor.execute('''
        SELECT COUNT(DISTINCT p.id) 
        FROM patients p 
        JOIN initial_visits iv ON p.patient_id = iv.patient_id 
        WHERE iv.pep_given = "Y" AND p.created_at BETWEEN ? AND ?
    ''', (start_date, end_date))
    pep_cases = cursor.fetchone()[0]
    
    # Monthly trend
    cursor.execute('''
        SELECT strftime('%Y-%m', created_at) as month, COUNT(*) as count
        FROM patients
        WHERE created_at >= date('now', '-6 months')
        GROUP BY month
        ORDER BY month
    ''')
    monthly_data = cursor.fetchall()
    months = [row[0] for row in monthly_data]
    counts = [row[1] for row in monthly_data]
    
    # Violence type distribution
    cursor.execute('''
        SELECT type_violence, COUNT(*) as count
        FROM patients
        WHERE created_at BETWEEN ? AND ?
        GROUP BY type_violence
    ''', (start_date, end_date))
    violence_data = cursor.fetchall()
    
    conn.close()
    
    return jsonify({
        'total_cases': total_cases,
        'new_cases': new_cases,
        'female_cases': female_cases,
        'child_cases': child_cases,
        'pep_cases': pep_cases,
        'monthly_trend': {
            'months': months,
            'counts': counts
        },
        'violence_distribution': [
            {'type': row[0] or 'Unknown', 'count': row[1]}
            for row in violence_data
        ]
    })

# ============ ERROR HANDLERS ============
@app.errorhandler(404)
def not_found(error):
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>404 - Page Not Found</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #dc3545; }
            .container { max-width: 600px; margin: 0 auto; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>404 - Page Not Found</h1>
            <p>The page you are looking for does not exist.</p>
            <a href="/">Go to Login</a>
        </div>
    </body>
    </html>
    ''', 404

@app.errorhandler(500)
def internal_error(error):
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>500 - Internal Server Error</title>
        <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #dc3545; }
            .container { max-width: 600px; margin: 0 auto; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>500 - Internal Server Error</h1>
            <p>Something went wrong on our end. Please try again later.</p>
            <a href="/">Go to Login</a>
        </div>
    </body>
    </html>
    ''', 500

# ============ MAIN ============
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)