{% extends "base.html" %}
{% block content %}
<h2>GBV Analytics Dashboard</h2>
<form method="GET" class="row mb-4">
    <div class="col-md-4">
        <label>Start Date</label>
        <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
    </div>
    <div class="col-md-4">
        <label>End Date</label>
        <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
    </div>
    <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
</form>

<!-- KPIs -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h5>Total Cases</h5>
                <h2>{{ total_cases }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <h5>% Female</h5>
                <h2>{{ female_pct }}%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <h5>% Minors</h5>
                <h2>{{ minors_pct }}%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h5>% Referred</h5>
                <h2>{{ referred_pct }}%</h2>
            </div>
        </div>
    </div>
</div>
<p class="text-muted">Most Affected Day: {{ 'Monday' if most_affected_day and most_affected_day[0] == '1' else 'Other' }} (Day {{ most_affected_day[0] if most_affected_day else 'N/A' }})</p>

<!-- Charts -->
<div class="row">
    <div class="col-md-6">
        <canvas id="timeChart"></canvas>
    </div>
    <div class="col-md-6">
        <canvas id="genderChart"></canvas>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-6">
        <canvas id="violenceChart"></canvas>
    </div>
    <div class="col-md-6">
        <canvas id="ageChart"></canvas>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-12">
        <canvas id="referralChart"></canvas>
    </div>
</div>

<script>
    const chartData = {{ chart_data | safe }};
    // Line Chart: Cases Over Time
    new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: { labels: chartData.time.labels, datasets: [{ label: 'Cases', data: chartData.time.values, borderColor: 'blue' }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    // Pie: Gender
    new Chart(document.getElementById('genderChart'), {
        type: 'pie',
        data: { labels: chartData.gender.labels, datasets: [{ data: chartData.gender.values, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'] }] },
        options: { responsive: true }
    });
    // Bar: Type of Violence
    new Chart(document.getElementById('violenceChart'), {
        type: 'bar',
        data: { labels: chartData.violence.labels, datasets: [{ label: 'Cases', data: chartData.violence.values, backgroundColor: 'rgba(75,192,192,0.2)' }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    // Bar: Age Groups
    new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: { labels: chartData.age.labels, datasets: [{ label: 'Cases', data: chartData.age.values, backgroundColor: 'rgba(153,102,255,0.2)' }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    // Pie: Referrals
    new Chart(document.getElementById('referralChart'), {
        type: 'doughnut',
        data: { labels: chartData.referral.labels, datasets: [{ data: chartData.referral.values, backgroundColor: ['#FF6384', '#36A2EB'] }] },
        options: { responsive: true }
    });
</script>
{% endblock %}