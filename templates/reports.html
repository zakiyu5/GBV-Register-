{% extends "base.html" %}

{% block title %}Reports - GBV Register{% endblock %}

{% block page_header %}
<i class="fas fa-chart-bar me-2"></i>Reports & Analytics
{% endblock %}

{% block page_subtitle %}
Generate and view comprehensive reports with visual analytics
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    {% if session.get('user_role') == 'super_admin' %}
    <button type="button" class="btn btn-success" onclick="exportReport()">
        <i class="fas fa-download me-2"></i> Export CSV
    </button>
    {% endif %}
    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
        <i class="fas fa-print me-2"></i> Print
    </button>
</div>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Filter Section -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Report Filters</h6>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('reports') }}" id="reportForm">
                <div class="row g-3">
                    <!-- Period Selection -->
                    <div class="col-md-3">
                        <label class="form-label">Time Period</label>
                        <select class="form-select" name="period" onchange="this.form.submit()">
                            <option value="all" {% if current_period == 'all' %}selected{% endif %}>All Time</option>
                            <option value="daily" {% if current_period == 'daily' %}selected{% endif %}>Daily</option>
                            <option value="weekly" {% if current_period == 'weekly' %}selected{% endif %}>Weekly</option>
                            <option value="monthly" {% if current_period == 'monthly' %}selected{% endif %}>Monthly</option>
                            <option value="quarterly" {% if current_period == 'quarterly' %}selected{% endif %}>Quarterly</option>
                            <option value="yearly" {% if current_period == 'yearly' %}selected{% endif %}>Yearly</option>
                        </select>
                    </div>
                    
                    <!-- Custom Date Range -->
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" name="start_date" value="{{ custom_start }}" onchange="this.form.submit()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" name="end_date" value="{{ custom_end }}" onchange="this.form.submit()">
                    </div>
                    
                    <!-- Search -->
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="search" value="{{ search }}" placeholder="Search...">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Additional Filters (Hidden by default, can be expanded) -->
                    <div class="col-12">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                            <i class="fas fa-chevron-down me-2"></i>Advanced Filters
                        </button>
                    </div>
                    
                    <div class="collapse {% if sex or violence or age_group or followup_filter %}show{% endif %}" id="advancedFilters">
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label">Gender</label>
                                <select class="form-select" name="sex" onchange="this.form.submit()">
                                    <option value="">All</option>
                                    <option value="F" {% if sex == 'F' %}selected{% endif %}>Female</option>
                                    <option value="M" {% if sex == 'M' %}selected{% endif %}>Male</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Violence Type</label>
                                <select class="form-select" name="violence" onchange="this.form.submit()">
                                    <option value="">All</option>
                                    {% for vt in violence_data %}
                                    <option value="{{ vt.type }}" {% if violence == vt.type %}selected{% endif %}>{{ vt.type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Age Group</label>
                                <select class="form-select" name="age_group" onchange="this.form.submit()">
                                    <option value="">All</option>
                                    <option value="child" {% if age_group == 'child' %}selected{% endif %}>Children (<18)</option>
                                    <option value="adult" {% if age_group == 'adult' %}selected{% endif %}>Adults (18+)</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Follow-up Status</label>
                                <select class="form-select" name="followup" onchange="this.form.submit()">
                                    <option value="">All</option>
                                    <option value="none" {% if followup_filter == 'none' %}selected{% endif %}>No Follow-ups</option>
                                    <option value="partial" {% if followup_filter == 'partial' %}selected{% endif %}>Partial (1-3)</option>
                                    <option value="complete" {% if followup_filter == 'complete' %}selected{% endif %}>Complete (4)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title text-uppercase">Total Cases</h6>
                    <h2>{{ total_cases }}</h2>
                    <small>{{ period }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title text-uppercase">Female</h6>
                    <h2>{{ female_cases }}</h2>
                    <small>{{ female_pct }}% of total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title text-uppercase">Children</h6>
                    <h2>{{ child_cases }}</h2>
                    <small>{{ child_pct }}% of total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title text-uppercase">PEP Given</h6>
                    <h2>{{ pep_cases }}</h2>
                    <small>{{ pep_pct }}% of total</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Monthly Trend -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Trend</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    {% if not monthly_data %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">No monthly data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Violence Type Distribution -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Violence Types</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="violenceChart"></canvas>
                    </div>
                    {% if not violence_data %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">No violence data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row of Charts -->
    <div class="row mb-4">
        <!-- Age Distribution -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user-friends me-2"></i>Age Distribution</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gender Distribution -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-venus-mars me-2"></i>Gender Distribution</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Follow-up Status -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Follow-up Status</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="followupChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Detailed Records ({{ total_cases }} records)</h6>
            <div>
                <span class="badge bg-info">Page 1 of 1</span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>OPD No.</th>
                            <th>Name</th>
                            <th>Age/Sex</th>
                            <th>Violence Type</th>
                            <th>Arrival Date</th>
                            <th>PEP</th>
                            <th>Follow-ups</th>
                            <th>Outcome</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td><span class="badge bg-primary">{{ record.patient_id }}</span></td>
                            <td>{{ record.client_name }}</td>
                            <td>{{ record.age }}/{{ record.sex }}</td>
                            <td>{{ record.type_violence or 'N/A' }}</td>
                            <td>{{ record.arrival_datetime[:10] }}</td>
                            <td>
                                {% if record.pep_given in ['Yes', 'Y'] %}
                                <span class="badge bg-success">Yes</span>
                                {% else %}
                                <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </td>
                            <td>{{ record.followup_count or 0 }}/4</td>
                            <td>
                                {% if record.outcome %}
                                <span class="badge bg-warning">{{ record.outcome }}</span>
                                {% else %}
                                <span class="badge bg-info">Active</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('view_patient', patient_id=record.patient_id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No records found</h5>
                                <p>Try adjusting your filters or register a new patient</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Prepare data from Flask
const monthlyData = [
    {% for item in monthly_data %}
    { month: '{{ item.month }}', count: {{ item.count }} },
    {% endfor %}
];

const violenceData = [
    {% for item in violence_data %}
    { type: '{{ item.type }}', count: {{ item.count }} },
    {% endfor %}
];

const ageData = [
    {% for item in age_distribution %}
    { group: '{{ item.group }}', count: {{ item.count }} },
    {% endfor %}
];

const genderData = [
    {% for item in gender_data %}
    { gender: '{{ item.gender }}', count: {{ item.count }} },
    {% endfor %}
];

const followupData = [
    {% for item in followup_status %}
    { status: '{{ item.status }}', count: {{ item.count }} },
    {% endfor %}
];

// Initialize all charts
document.addEventListener('DOMContentLoaded', function() {
    // Color palette
    const colors = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
        '#5a5c69', '#858796', '#6610f2', '#fd7e14', '#20c9a6'
    ];
    
    // Monthly Chart
    if (monthlyData.length > 0) {
        new Chart(document.getElementById('monthlyChart'), {
            type: 'line',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: 'Number of Cases',
                    data: monthlyData.map(item => item.count),
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#4e73df'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Violence Chart
    if (violenceData.length > 0) {
        new Chart(document.getElementById('violenceChart'), {
            type: 'doughnut',
            data: {
                labels: violenceData.map(item => item.type),
                datasets: [{
                    data: violenceData.map(item => item.count),
                    backgroundColor: colors.slice(0, violenceData.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    // Age Chart
    if (ageData.length > 0) {
        new Chart(document.getElementById('ageChart'), {
            type: 'bar',
            data: {
                labels: ageData.map(item => item.group),
                datasets: [{
                    label: 'Number of Cases',
                    data: ageData.map(item => item.count),
                    backgroundColor: '#36b9cc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Gender Chart
    if (genderData.length > 0) {
        new Chart(document.getElementById('genderChart'), {
            type: 'pie',
            data: {
                labels: genderData.map(item => item.gender),
                datasets: [{
                    data: genderData.map(item => item.count),
                    backgroundColor: ['#4e73df', '#f6c23e', '#858796']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // Follow-up Chart
    if (followupData.length > 0) {
        new Chart(document.getElementById('followupChart'), {
            type: 'doughnut',
            data: {
                labels: followupData.map(item => item.status),
                datasets: [{
                    data: followupData.map(item => item.count),
                    backgroundColor: ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
});

// Export function
function exportReport() {
    const form = document.getElementById('reportForm');
    const url = new URL('/export_csv', window.location.origin);
    new URLSearchParams(new FormData(form)).forEach((value, key) => {
        url.searchParams.append(key, value);
    });
    window.location.href = url;
}

// Print function
window.print = function() {
    window.print();
};
</script>

<style>
.stat-card {
    border-radius: 10px;
    border: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.card {
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 1rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    font-weight: 600;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.btn-group .btn {
    margin-left: 5px;
}
</style>
{% endblock %}